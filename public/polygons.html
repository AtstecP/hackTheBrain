<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Climate Disasters</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/d3-geo.v2.min.js"></script>
    <script src="https://unpkg.com/globe.gl"></script>
</head>

<body>

    <header>
        <h1>CLIMATE<br />DISASTERS</h1>
    </header>
    <br><br>
    <div class="frame">
        <div id="globe-container"></div>
    </div>

    <script>
        function getPolygonCenter(geometry) {
            let coords = [];

            if (geometry.type === "Polygon") {
                coords = geometry.coordinates[0]; // внешний контур
            } else if (geometry.type === "MultiPolygon") {
                // берём первый внешний контур первого полигона
                coords = geometry.coordinates[0][0];
            }

            const avgLat = coords.reduce((sum, c) => sum + c[1], 0) / coords.length;
            const avgLng = coords.reduce((sum, c) => sum + c[0], 0) / coords.length;

            return { avgLat, avgLng };
        }
        function isPolygonNear(coord, geometry, threshold) {
            const allPoints = [];

            if (geometry.type === "Polygon") {
                geometry.coordinates.forEach(ring => allPoints.push(...ring));
            } else if (geometry.type === "MultiPolygon") {
                geometry.coordinates.forEach(polygon =>
                    polygon.forEach(ring => allPoints.push(...ring))
                );
            }

            return allPoints.some(point => {
                const dist = Math.sqrt(
                    Math.pow(coord.lat - point[1], 2) + Math.pow(coord.lng - point[0], 2)
                );
                return dist < threshold;
            });
        }


        const globeContainer = document.getElementById('globe-container');

        const disasterLocations = [
            { lat: 55.7558, lng: 37.6173, name: "Москва" },
            { lat: 48.8566, lng: 2.3522, name: "Париж" },
            { lat: 40.7128, lng: -74.0060, name: "Нью-Йорк" },
            { lat: 35.6895, lng: 139.6917, name: "Токио" }
        ];

        fetch('ne_110m_admin_0_countries.geojson')
            .then(res => res.json())
            .then(countries => {
                const world = Globe()(globeContainer)
                    .globeImageUrl('//cdn.jsdelivr.net/npm/three-globe/example/img/earth-blue-marble.jpg')
                    .hexPolygonsData(countries.features)
                    .hexPolygonResolution(3)
                    .hexPolygonMargin(0.3)
                    .hexPolygonUseDots(true)
                    .hexPolygonColor(() => '#444')
                    .labelLat(d => d.lat)
                    .labelLng(d => d.lng)
                    .labelText(() => '')
                    .labelDotRadius(0.4)
                    .labelColor(() => 'red')
                    .labelsData(disasterLocations);
            })
            .catch(err => console.error("Ошибка загрузки GeoJSON:", err));

    </script>

</body>

</html>